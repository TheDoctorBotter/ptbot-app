name: Deploy Supabase Edge Functions

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'supabase/functions/**'
      - 'supabase/config.toml'   # also redeploy when JWT/config settings change
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Deploy Edge Functions
        # --no-verify-jwt overrides config.toml and guarantees the Supabase gateway
        # passes the original user JWT untouched to every function.  Each function
        # validates the JWT itself via supabase.auth.getUser(token).  Without this
        # flag, verify_jwt = true causes the gateway to replace the Authorization
        # header with a service-role token before forwarding the request, which
        # makes the function's own getUser() call return 401 for every user.
        run: |
          supabase functions deploy calendar-availability --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --no-verify-jwt
          supabase functions deploy calendar-book --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --no-verify-jwt
          supabase functions deploy calendar-appointments --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --no-verify-jwt
          supabase functions deploy stripe-checkout --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --no-verify-jwt
          supabase functions deploy stripe-webhook --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --no-verify-jwt
          supabase functions deploy openai-proxy --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --no-verify-jwt
          supabase functions deploy emr-export --project-ref ${{ secrets.SUPABASE_PROJECT_ID }} --no-verify-jwt
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
